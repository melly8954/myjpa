<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>회원가입 페이지</title>
</head>
<script src="/js/jquery-3.7.1.min.js"></script>
<body>
    <div>
        <form action="/api/users/register" method="post">
            <label for="loginId">로그인 ID 입력란</label><br>
            <input type="text" id="loginId" name="loginId" placeholder="로그인 ID 입력"><br>

            <label for="password">로그인 Password 입력란</label><br>
            <input type="password" id="password" name="password" placeholder="로그인 Password 입력"><br>

            <label for="confirmPassword">Password 재입력</label><br>
            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Password 재입력"><br>

            <label for="name">회원자 이름 입력란</label><br>
            <input type="text" id="name" name="name" placeholder="이름 입력"><br>

            <label for="nickname">사용할 닉네임 입력란</label><br>
            <input type="text" id="nickname" name="nickname" placeholder="닉네임 입력"><br>

            <label for="email">이메일 입력란</label><br>
            <input type="email" id="email" name="email" placeholder="email 입력"><br>
            <button type="button" id="check-email-button" class="light-button">중복확인</button>
            <span id="emailCheckMessage" class="error"></span>

            <button type="button" id="send-code-button" class="light-button" style="display: none;">인증 코드 발송</button>

            <div id="verifyCodeSection">
                <label for="verificationCode">인증 코드</label>
                <input type="text" id="verificationCode" name="verificationCode" placeholder="인증번호 입력" required/>
                <button type="button" id="verify-code-button" class="light-button">이메일 인증</button>
                <span id="verificationMessage" class="error"></span>
            </div>

            <button id="submit" type="submit">회원 가입</button><br>
            <button id="reset_button" type="reset">초기화</button>
        </form>
    </div>
</body>
<script>
    $(document).ready(function () {
        $('#send-code-button').hide(); // 인증 메일 발송 버튼 숨기기
        $('#verifyCodeSection').hide(); // 인증 코드 입력란 숨기기
        validateForm(); // 초기 상태 확인
    });

    $("#submit").on("click", function (event) {
        event.preventDefault(); // 기본 폼 전송 막기

        const formData = {
            loginId: $("#loginId").val(),
            password: $("#password").val(),
            confirmPassword: $("#confirmPassword").val(),
            name: $("#name").val(),
            nickname: $("#nickname").val(),
            email: $("#email").val()
        };

        $.ajax({
            url: "/api/users/register",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(formData)
        }).done(function (data) {
            // 요청 성공 시 실행
            if (data.message === "회원 가입 성공!") {
                alert("회원가입이 성공적으로 완료되었습니다!");
                window.location.href = "/";
            } else {
                alert("회원가입 실패: " + data.message);
            }
        }).fail(function (jqXHR, textStatus, errorThrown) {
            // 요청 실패 시 실행
            console.error("Request failed: " + textStatus + ", " + errorThrown);
            alert("회원가입 중 오류가 발생했습니다.");
        });
    });

    function validateForm() {
        let isValid = true;

        // 이메일 중복 확인 상태 체크
        if ($('#emailCheckMessage').hasClass('error')) {
            isValid = false;
        }

        // 이메일 인증 상태 체크
        if (!$('#verificationMessage').hasClass('success')) {
            isValid = false;
        }

        // 비밀번호 일치 여부 확인
        const password = $('#password').val();
        const confirmPassword = $('#confirmPassword').val();
        if (password !== confirmPassword || password === '') {
            isValid = false;
        }

        // 폼 전체 상태를 기준으로 회원가입 버튼 활성화/비활성화
        $('#submit').prop('disabled', !isValid);
        return isValid;
    }


    // 이메일 중복 검사
    // 1. 이메일 중복되면 인증 메일 보내기 버튼은 숨김
    // 2. 이메일 중복이 없다면 인증 메일 보내기 버튼 활성화 됨
    $('#check-email-button').on('click', function() {
        let email = $('#email').val();

        $.ajax({
            type: 'POST',
            url: '/api/users/check-email',
            contentType: 'application/json',
            data: JSON.stringify({ mail: email }),
            success: function(response) {
                if (response) {
                    $('#emailCheckMessage').text("아이디가 이미 존재합니다.").removeClass('success').addClass('error');
                    $('#send-code-button').hide();
                } else {
                    $('#emailCheckMessage').text("사용 가능한 아이디입니다.").removeClass('error').addClass('success');
                    $('#send-code-button').show();
                }
                validateForm();
            },
            error: function(error) {
                $('#emailCheckMessage').text('이메일 확인 중 오류가 발생했습니다. 다시 시도해주세요.').removeClass('success').addClass('error');
                $('#send-code-button').hide();
                validateForm();
            }
        });
    });

    // 인증 메일 발송
    $('#send-code-button').on('click', function() {
        let email = $('#email').val();

        $.ajax({
            type: 'POST',
            url: '/api/users/mail',
            contentType: 'application/json',
            data: JSON.stringify({ mail: email }),
            success: function(response) {
                $('#verifyCodeSection').show();
                alert('인증 메일이 발송되었습니다. 인증 번호를 확인해주세요.');
            },
            error: function(error) {
                alert('메일 발송에 실패했습니다. 다시 시도해주세요.');
            }
        });
    });

    // 인증 코드 확인
    $('#verify-code-button').on('click', function() {
        let email = $('#email').val();
        let code = $('#verificationCode').val();

        $.ajax({
            type: 'POST',
            url: '/api/users/verify-code',
            contentType: 'application/json',
            data: JSON.stringify({ mail: email, code: code }),
            success: function(response) {
                if (response === 'Verified') {
                    $('#verificationMessage').text('인증 성공').removeClass('error').addClass('success');
                } else {
                    $('#verificationMessage').text('인증 실패. 올바른 코드를 입력하세요.').removeClass('success').addClass('error');
                }
                validateForm(); // 폼 상태 다시 확인
            },
            error: function(error) {
                $('#verificationMessage').text('인증 실패. 다시 시도해주세요.').removeClass('success').addClass('error');
                validateForm(); // 폼 상태 다시 확인
            }
        });
    });

</script>
</html>